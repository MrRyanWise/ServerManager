npm install -g @angular/cli
npm WARN invalid config registry=""
npm WARN invalid config Must be a full url with 'http://'
npm WARN invalid config registry=""
npm WARN invalid config Must be a full url with 'http://'
npm ERR! code ENOTFOUND
npm ERR! errno ENOTFOUND
npm ERR! network request to https://registry.npmjs.org/@angular%2fcli failed, reason: getaddrinfo ENOTFOUND registry.npmjs.org
npm ERR! network This is a problem related to network connectivity.
npm ERR! network In most cases you are behind a proxy or have bad network settings.
npm ERR! network
npm ERR! network If you are behind a proxy, please make sure that the
npm ERR! network 'proxy' config is set properly.  See: 'npm help config'

npm ERR! A complete log of this run can be found in:
npm ERR!     C:\Users\psxd044\AppData\Roaming\npm-cache\_logs\2024-02-23T09_30_55_318Z-debug.log

<<<<<<<<<<<<
0 info it worked if it ends with ok
1 verbose cli [
1 verbose cli   'C:\\ProgramData\\espdev\\applications\\node-v12.22.7-win-x64\\node.exe',
1 verbose cli   'C:\\ProgramData\\espdev\\applications\\node-v12.22.7-win-x64\\node_modules\\npm\\bin\\npm-cli.js',
1 verbose cli   'run',
1 verbose cli   'start'
1 verbose cli ]
2 info using npm@6.14.15
3 info using node@v12.22.7
4 verbose run-script [ 'prestart', 'start', 'poststart' ]
5 info lifecycle h7z-project@0.0.4-SNAPSHOT~prestart: h7z-project@0.0.4-SNAPSHOT
6 info lifecycle h7z-project@0.0.4-SNAPSHOT~start: h7z-project@0.0.4-SNAPSHOT
7 verbose lifecycle h7z-project@0.0.4-SNAPSHOT~start: unsafe-perm in lifecycle true
8 verbose lifecycle h7z-project@0.0.4-SNAPSHOT~start: PATH: C:\ProgramData\espdev\applications\node-v12.22.7-win-x64\node_modules\npm\node_modules\npm-lifecycle\node-gyp-bin;C:\ProgramData\espdev\Workspace\h7z\front\node_modules\.bin;C:\Program Files (x86)\Common Files\Oracle\Java\javapath;C:\Program Files (x86)\RSA SecurID Token Common;C:\Program Files\RSA SecurID Token Common;C:\windows\system32;C:\windows;C:\windows\System32\Wbem;C:\windows\System32\WindowsPowerShell\v1.0\;C:\windows\System32\OpenSSH\;C:\Program Files (x86)\Pulse Secure\VC142.CRT\X64\;C:\Program Files (x86)\Pulse Secure\VC142.CRT\X86\;C:\Program Files (x86)\Common Files\Pulse Secure\TNC Client Plugin\;C:\Program Files (x86)\Common Files\Pulse Secure\VC142.CRT\X64\;C:\Program Files (x86)\Common Files\Pulse Secure\VC142.CRT\X86\;C:\Program Files (x86)\DISFE\GestionDesLogs;C:\Users\psxd044\AppData\Local\Microsoft\WindowsApps;C:\Users\psxd044\OneDrive - LA POSTE GROUPE\Bureau\Docs\Applications\git\cmd;C:\ProgramData\espdev\apache-maven-3.9.3\bin;C:\ProgramData\espdev\applications\node-v12.22.7-win-x64;C:\Users\psxd044\AppData\Local\GitHubDesktop\bin;C:\Users\psxd044\OneDrive - LA POSTE GROUPE\Bureau\Docs\Applications\Microsoft VS Code\bin;
9 verbose lifecycle h7z-project@0.0.4-SNAPSHOT~start: CWD: C:\ProgramData\espdev\Workspace\h7z\front
10 silly lifecycle h7z-project@0.0.4-SNAPSHOT~start: Args: [ '/d /s /c', 'ng serve --proxy-config proxy.conf.json' ]
11 info lifecycle h7z-project@0.0.4-SNAPSHOT~start: Failed to exec start script
12 verbose stack Error: h7z-project@0.0.4-SNAPSHOT start: `ng serve --proxy-config proxy.conf.json`
12 verbose stack spawn ENOENT
12 verbose stack     at ChildProcess.<anonymous> (C:\ProgramData\espdev\applications\node-v12.22.7-win-x64\node_modules\npm\node_modules\npm-lifecycle\lib\spawn.js:48:18)
12 verbose stack     at ChildProcess.emit (events.js:314:20)
12 verbose stack     at maybeClose (internal/child_process.js:1022:16)
12 verbose stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:287:5)
13 verbose pkgid h7z-project@0.0.4-SNAPSHOT
14 verbose cwd C:\ProgramData\espdev\Workspace\h7z\front
15 verbose Windows_NT 10.0.19045
16 verbose argv "C:\\ProgramData\\espdev\\applications\\node-v12.22.7-win-x64\\node.exe" "C:\\ProgramData\\espdev\\applications\\node-v12.22.7-win-x64\\node_modules\\npm\\bin\\npm-cli.js" "run" "start"
17 verbose node v12.22.7
18 verbose npm  v6.14.15
19 error code ELIFECYCLE
20 error syscall spawn
21 error file C:\windows\system32\cmd.exe
22 error errno ENOENT
23 error h7z-project@0.0.4-SNAPSHOT start: `ng serve --proxy-config proxy.conf.json`
23 error spawn ENOENT
24 error Failed at the h7z-project@0.0.4-SNAPSHOT start script.
24 error This is probably not a problem with npm. There is likely additional logging output above.
25 verbose exit [ 1, true ]
<<<<<<<<<
describe('ListPieceComponent2', () => {
  const activatedRoute = createSpyObj('ActivatedRoute', [], {snapshot: getParamMap("1234")} )
  const component = new ListPieceComponent(activatedRoute);
  component.pieces = [
    {
      identifiant: '12345456',
      libelle: '',
      dateAcquisition: null,
      categorie: {
        code: 'CT01',
        libelle: 'Mon libelle'
      },
      format: 'PDF',
      taille:'33',
      document: 'JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PC9DcmVhdG9yIChNb3ppbGxhLzUuMCBcKFdpbmRvd3MgTlQgMTAuMD',

      contenuToBlob(): Blob {
        return null;
      },

      getBlobProperty(): BlobPropertyBag {
        return null;
      }
    }];
  function getParamMap(id: string) {
    const paramMap = new Map<string, string>();
    paramMap.set('identifiantDossierCollecte', id);
    return { paramMap };
  }
  it('should create', () => {
    expect(component).toBeTruthy();
  });
  it('should set pieces from route snapshot data', () => {
    const piecesResult: PieceDemande[] = [
      {
        identifiant: '12345456',
        libelle: '',
        dateAcquisition: null,
        categorie: {
          code: 'CT01',
          libelle: 'Mon libelle'
        },
        format: 'PDF',
        taille:'33',
        document: 'JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PC9DcmVhdG9yIChNb3ppbGxhLzUuMCBcKFdpbmRvd3MgTlQgMTAuMD',

        contenuToBlob(): Blob {
          return null;
        },

        getBlobProperty(): BlobPropertyBag {
          return null;
        }
      }]
    expect(component.pieces).toEqual(piecesResult);
  });
});
///////////////////

 import {Injectable} from "@angular/core";
 import {NetworkService} from "./shared/network.service";
 import {Observable} from "rxjs";
 import {PieceDemande} from "../model/PieceDemande";
 import {KEY_RECUPERATION_PIECE_DEMANDE} from "../utils/api-map-constantes";

 @Injectable({
   providedIn: 'root'
 })
 export class PieceService {


   constructor(private http: NetworkService) {
   }

   /**
    * Renvoie un dossier en fonction du dossier demandé
    * @param identifiantDossierCollecte
    */
   public recupererPiecesDemande(identifiantDossier: string): Observable<PieceDemande[]> {
     const expandData = {identifiantDossier};
     return this.http.get<PieceDemande[]>(KEY_RECUPERATION_PIECE_DEMANDE, expandData, 'PieceService', 'recupererPiecesDemande');
   }

   /**
    * Permet de creer un Blob depuis le pdf encodé
    */
   public pdfToBlob(pdf: string): Blob {
     //conversion du pdf encodé en byte
     const pdfByte = atob(pdf);
     const pdfDecode = new TextDecoder().decode(Uint8Array.from(pdfByte, element => element.codePointAt(0)));
     //construction de l'objet a partir duquel l'url sera généré
     return new Blob([pdfDecode], {type: 'application/pdf'});
   }

 }

///

import {ActivatedRouteSnapshot, Resolve, RouterStateSnapshot} from "@angular/router";
import {Observable} from "rxjs";
import {inject, Injectable} from "@angular/core";
import {PieceService} from "./piece.service";
import {PieceDemande} from "../model/PieceDemande";
import {map} from "rxjs/operators";

@Injectable({
  providedIn: 'root'
})
export class PieceResolver implements Resolve<Observable<PieceDemande[]>> {

  private pieceService = inject(PieceService);

  resolve(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable<PieceDemande[]> {
    return this.pieceService.recupererPiecesDemande(route.paramMap.get('identifiantDossierCollecte')).pipe(map(
      pieces => pieces.map(
        piece => {
          let instance = new PieceDemande();
          Object.assign(instance, piece);
          return instance;
        })
    ));
  }

}


/////////////////////////////////////

import { TestBed } from '@angular/core/testing';
import { PieceResolver } from './piece-resolver.service';
import { RouterTestingModule } from '@angular/router/testing';
import { ActivatedRouteSnapshot, RouterStateSnapshot, Router } from '@angular/router';
import { of } from 'rxjs';
import { PieceService } from './piece.service'; // Import du service de pièces
import { PieceDemande } from './piece-demande.model'; // Import du modèle de pièce demande

describe('PieceResolver', () => {
  let resolver: PieceResolver;
  let pieceServiceSpy: jasmine.SpyObj<PieceService>;
  let routerSpy: jasmine.SpyObj<Router>;

  beforeEach(() => {
    const pieceServiceSpyObj = jasmine.createSpyObj('PieceService', ['recupererPiecesDemande']);
    const routerSpyObj = jasmine.createSpyObj('Router', ['navigateByUrl']);

    TestBed.configureTestingModule({
      imports: [RouterTestingModule],
      providers: [
        { provide: PieceService, useValue: pieceServiceSpyObj },
        { provide: Router, useValue: routerSpyObj }
      ]
    });

    resolver = TestBed.inject(PieceResolver);
    pieceServiceSpy = TestBed.inject(PieceService) as jasmine.SpyObj<PieceService>;
    routerSpy = TestBed.inject(Router) as jasmine.SpyObj<Router>;
  });

  it('should be created', () => {
    expect(resolver).toBeTruthy();
  });

  it('should resolve pieces', () => {
    const pieces: PieceDemande[] = []; // Mettez vos données de test ici
    pieceServiceSpy.recupererPiecesDemande.and.returnValue(of(pieces));

    const route: ActivatedRouteSnapshot = new ActivatedRouteSnapshot();
    route.paramMap = jasmine.createSpyObj('ParamMap', ['get']);
    route.paramMap.get.and.returnValue('dummyId');

    const state: RouterStateSnapshot = jasmine.createSpyObj('RouterStateSnapshot', ['toString']);

    resolver.resolve(route, state).subscribe(resolvedPieces => {
      expect(resolvedPieces).toEqual(pieces);
    });

    expect(pieceServiceSpy.recupererPiecesDemande).toHaveBeenCalledWith('dummyId');
  });

  it('should handle error', () => {
    pieceServiceSpy.recupererPiecesDemande.and.returnValue(of(null)); // Simuler une erreur

    const route: ActivatedRouteSnapshot = new ActivatedRouteSnapshot();
    route.paramMap = jasmine.createSpyObj('ParamMap', ['get']);
    route.paramMap.get.and.returnValue('dummyId');

    const state: RouterStateSnapshot = jasmine.createSpyObj('RouterStateSnapshot', ['toString']);

    resolver.resolve(route, state).subscribe(resolvedPieces => {
      expect(resolvedPieces).toBeNull();
      expect(routerSpy.navigateByUrl).toHaveBeenCalledWith('/error');
    });

    expect(pieceServiceSpy.recupererPiecesDemande).toHaveBeenCalledWith('dummyId');
  });
});

::::::::::
package fr.laposte.disf.canal.h7z.api.piecedemande;

import fr.laposte.disf.canal.client.h5z.modeles.ErrorModel;
import fr.laposte.disf.canal.h7z.api.piecedemande.mapper.PieceDemandeMapper;
import fr.laposte.disf.canal.h7z.api.piecedemande.model.PieceDemandeApi;
import fr.laposte.disf.canal.h7z.domain.Contenu;
import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disf.canal.h7z.domain.DossierFacade;
import fr.laposte.disf.canal.h7z.domain.service.ContenuService;
import fr.laposte.disf.canal.h7z.helper.AppConstants;
import fr.laposte.disf.fwmc.arch.rest.annotation.ResourceMap;
import fr.laposte.disf.fwmc.arch.rest.annotation.ResourceVersion;
import fr.laposte.disf.fwmc.arch.rest.annotation.RestCtrlResource;
import fr.laposte.disf.fwmc.arch.rest.impl.DefaultController;
import fr.laposte.disf.fwmc.core.ApplicationManager;
import fr.laposte.disf.fwmc.core.error.ApplicationException;
import fr.laposte.disf.fwmc.core.log.Logger;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.annotation.Secured;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestParam;
import reactor.core.publisher.Mono;

import java.util.List;

import static fr.laposte.disf.canal.h7z.api.piecedemande.ApiMapConstantes.KEY_RECUPERATION_CONTENU_PDF;
import static fr.laposte.disf.canal.h7z.api.piecedemande.ApiMapConstantes.KEY_RECUPERATION_PIECES_DEMANDE_PAR_ID_DOSSIER;
import static fr.laposte.disf.canal.h7z.api.piecedemande.ApiMapConstantes.URL_RECUPERATION_CONTENU_PDF;
import static fr.laposte.disf.canal.h7z.api.piecedemande.ApiMapConstantes.URL_RECUPERATION_PIECES_DEMANDE_PAR_ID_DOSSIER;

@ResourceVersion(1)
@RequiredArgsConstructor(onConstructor = @__(@Autowired))
@RestCtrlResource(url = "/demande")
public class PieceDemandeController extends DefaultController {

    private static final Logger LOGGER = ApplicationManager.getLogger(PieceDemandeController.class);

    private final DossierFacade facade;

    private final PieceDemandeMapper pieceDemandeMapper;

    private final ContenuService contenuService;


    @Secured(AppConstants.SERVICE_BANCAIRE_SB096)
    @GetMapping(value = URL_RECUPERATION_PIECES_DEMANDE_PAR_ID_DOSSIER, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)
    @ResourceMap(rel = KEY_RECUPERATION_PIECES_DEMANDE_PAR_ID_DOSSIER, genParams = ResourceMap.Generate.BY_VALUE_ELSE_BY_NAME)
    @ApiOperation(value = KEY_RECUPERATION_PIECES_DEMANDE_PAR_ID_DOSSIER, notes = "Récupère les documents de la demande")
    // TODO : mettre une liste dans ApiResponse et non juste l'objet.
    @ApiResponses(value = {@ApiResponse(code = 200, message = "Documents récupérés", response = PieceDemandeApi.class), @ApiResponse(code = 404, message = "Documents non trouvés", response = ErrorModel.class),
            @ApiResponse(code = 500, message = "Erreur système", response = ErrorModel.class)})
    public Mono<ResponseEntity<List<PieceDemandeApi>>> recuperer(
            @PathVariable(value = "identifiantDossier") final String identifiantDossier) throws ApplicationException {
        LOGGER.info("[PieceDemandeController.recuperer] identifiant dossier : %s", identifiantDossier);

        var listePiecesDemandeApi = pieceDemandeMapper.mapList(facade.recupererPieces(identifiantDossier));

        LOGGER.info("[PieceDemandeController.recuperer] pieces de la demande : %s", listePiecesDemandeApi);

        return Mono.just(ResponseEntity.ok(listePiecesDemandeApi));
    }

    @GetMapping(value = URL_RECUPERATION_CONTENU_PDF, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)
    @ResourceMap(rel = KEY_RECUPERATION_CONTENU_PDF, genParams = ResourceMap.Generate.BY_VALUE_ELSE_BY_NAME)
    @ApiOperation(value = KEY_RECUPERATION_CONTENU_PDF, notes = "Récupère le contenu pdf du document")
    @ApiResponses(value = {@ApiResponse(code = 200, message = "Documents récupérés", response = byte[].class), @ApiResponse(code = 404, message = "Documents non trouvés", response = ErrorModel.class),
        @ApiResponse(code = 500, message = "Erreur système", response = ErrorModel.class)})
    public Mono<ResponseEntity<Contenu>> recupererContenuPdf(
        @PathVariable final String identifiantPiece,
        @RequestParam final String codeTypologie,
        @RequestParam final String codeContexte,
        @RequestParam final String codeEtablissement,
        @RequestParam final String codeAuthentification) {
        LOGGER.info("[PieceDemandeController.recupereDocument] identifiant piece : %s", identifiantPiece);

        var contexte = ContextePiece.builder().codeContexte(codeContexte).codeEtablissement(codeEtablissement).codeAuthentification(codeAuthentification).build();
        var contenu = contenuService.recuperer(identifiantPiece, codeTypologie, contexte);

        LOGGER.info("[PieceDemandeController.recupererDocument] contenu de la piece present : %s", contenu.isPresent());

        return Mono.just(ResponseEntity.ok(contenu));
    }



}




package fr.laposte.disf.canal.h7z.api;

import fr.laposte.disf.canal.h7z.api.piecedemande.PieceDemandeController;
import fr.laposte.disf.canal.h7z.api.piecedemande.mapper.PieceDemandeMapper;
import fr.laposte.disf.canal.h7z.domain.DossierFacade;
import fr.laposte.disf.canal.h7z.domain.PieceDemande;
import fr.laposte.disf.canal.h7z.fixture.PieceDemandeFixture;
import fr.laposte.disfe.fwroa.test.bootstrap.DefaultCanalTest;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.MvcResult;

import java.util.ArrayList;
import java.util.List;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.asyncDispatch;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.request;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@RunWith(MockitoJUnitRunner.Silent.class)
public class PieceDemandeControllerTest extends DefaultCanalTest {

    private MockMvc mockMvc;

    @Mock
    private DossierFacade facade;

    @Mock
    private PieceDemandeMapper mapper;

    PieceDemandeController pieceDemandeController;

    @Before
    public void prepare() {
        pieceDemandeController = new PieceDemandeController(facade, mapper, null);
        mockMvc = standaloneBuild(pieceDemandeController);
    }

    @Test
    public void testRecupererPieceDemande() throws Exception {
        String idDossier = "123456";
        List<PieceDemande> pieceDemandeList = new ArrayList<>();
        var pieceDemande = PieceDemandeFixture.getDefault();
        pieceDemandeList.add(pieceDemande);
        Mockito.doReturn(pieceDemandeList).when(facade).recupererPieces(idDossier);
        final MvcResult mvcResult = mockMvc.perform(get("/api/v1/demande/{identifiantDossier}/pieces", idDossier).contentType(MediaType.APPLICATION_JSON_VALUE)).andExpect(request().asyncStarted()).andReturn();
        mockMvc.perform(asyncDispatch(mvcResult)).andExpect(status().isOk());
    }


}
------------------
import fr.laposte.disf.canal.h7z.api.piecedemande.PieceDemandeController;
import fr.laposte.disf.canal.h7z.domain.Contenu;
import fr.laposte.disf.canal.h7z.domain.service.ContenuService;
import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disfe.fwroa.test.bootstrap.DefaultCanalTest;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.MockitoJUnitRunner;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.MvcResult;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;
import static org.springframework.test.web.servlet.setup.MockMvcBuilders.standaloneSetup;

@RunWith(MockitoJUnitRunner.class)
public class PieceDemandeControllerTest extends DefaultCanalTest {

    private MockMvc mockMvc;

    @Mock
    private ContenuService contenuService;

    PieceDemandeController pieceDemandeController;

    @Before
    public void prepare() {
        pieceDemandeController = new PieceDemandeController(null, null, contenuService);
        mockMvc = standaloneSetup(pieceDemandeController).build();
    }

    @Test
    public void testRecupererContenuPdf() throws Exception {
        // Configuration des valeurs de test
        String identifiantPiece = "PIECE123";
        String codeTypologie = "TYP1";
        String codeContexte = "CTX1";
        String codeEtablissement = "EST1";
        String codeAuthentification = "AUTH1";

        // Création d'un objet Contenu de test
        Contenu contenu = new Contenu();
        contenu.setContenu(new byte[]{1, 2, 3, 4}); // exemple de contenu

        // Simuler le comportement du service
        Mockito.doReturn(contenu).when(contenuService).recuperer(identifiantPiece, codeTypologie,
            ContextePiece.builder()
            .codeContexte(codeContexte)
            .codeEtablissement(codeEtablissement)
            .codeAuthentification(codeAuthentification)
            .build());

        // Effectuer la requête GET à l'URL de la méthode testée
        MvcResult mvcResult = mockMvc.perform(
            get("/api/v1/demande/piece/{identifiantPiece}", identifiantPiece)
            .param("codeTypologie", codeTypologie)
            .param("codeContexte", codeContexte)
            .param("codeEtablissement", codeEtablissement)
            .param("codeAuthentification", codeAuthentification)
            .contentType(MediaType.APPLICATION_JSON_VALUE))
            .andExpect(status().isOk()) // Vérifier que la réponse est OK
            .andReturn();
    }
}






ààààààààààà
GedAccesseur
package fr.laposte.disf.canal.h7z.isolation.ged;

import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disf.canal.h7z.domain.PieceDemande;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.ListeObjetsV3;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.QNIFlux;
import fr.laposte.disf.canal.h7z.trace.dpi.TracesDpiUtils;
import fr.laposte.disf.fwmc.arch.rest.http.ReactorAsyncRestOperations;
import fr.laposte.disf.fwmc.core.ApplicationManager;
import fr.laposte.disf.fwmc.core.log.Logger;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpEntity;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;
import reactor.core.publisher.Mono;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static fr.laposte.disf.canal.h7z.api.piecedemande.ApiMapConstantes.KEY_RECUPERER_DOCUMENT;

@Component
@RequiredArgsConstructor(onConstructor = @__(@Autowired))
public class GedAccesseur {

    private static final Logger LOGGER = ApplicationManager.getLogger(GedAccesseur.class);

    private final Map<String, String> api;

    private static final String IDLOGIQUE = "idLogique";
    private static final String CODE_CONTEXTE = "codeContexte";
    private static final String CODE_ETAB = "codeEtab";
    private static final String CODE_AUTH = "codeAuth";
    private static final String CODE_TYPOLOGIE = "codeTypologie";

    private final ReactorAsyncRestOperations reactAsyncRestOperations;


    public ListeObjetsV3 recupererPiece(String idContenu, ContextePiece contextePiece) {

        final String url = ApplicationManager.getProperty("URL_RECHERCHER_LISTE_OBJET_GED_V3");
        final String nomsParametres = "[ID_CONTENU]";
        final String valeursParametres = "[".concat(idContenu).concat("]");

        try {
            LOGGER.debug("QNI [listerObjet] url : %s", url);
            LOGGER.debug("QNI [listerObjet] noms parametres : %s, valeurs : %s", nomsParametres, valeursParametres);
            LOGGER.debug("QNI [listerObjet] valeurs parametres : %s", valeursParametres);
            LOGGER.debug("QNI [listerObjet] contexte : %s", contextePiece);

            return reactAsyncRestOperations.getForEntity(url, ListeObjetsV3.class, contextePiece.getCodeEtablissement(),
                    contextePiece.getCodeAuthentification(), contextePiece.getCodeContexte(), nomsParametres, valeursParametres).map(ResponseEntity::getBody).block();

        } catch (Exception ex) {
            TracesDpiUtils.tracerErreur(3, ex, GedAccesseur.class);
            LOGGER.error("QNI [listerObjetsV3] url : %s, criteres : %s, valeur : %s, contexte : %s", url, nomsParametres, valeursParametres, contextePiece);
            throw ex;
        }
    }

    public QNIFlux recupererDocumentSiPlusieursContextes(String idPiece, String codeTypologie, List<ContextePiece> contextes) {

        String serviceUrl = api.get(KEY_RECUPERER_DOCUMENT);

        String urlTemplate = getUrlTemplate(serviceUrl);

        List<Mono<QNIFlux>> appelsQNI = new ArrayList<>();
        try {
            for (ContextePiece contexte : contextes) {
                Map<String, String> params = new HashMap<>();
                params.put(IDLOGIQUE, idPiece);
                params.put(CODE_CONTEXTE, contexte.getCodeContexte());
                params.put(CODE_ETAB, contexte.getCodeEtablissement());
                params.put(CODE_AUTH, contexte.getCodeAuthentification());
                params.put(CODE_TYPOLOGIE, codeTypologie);

                appelsQNI.add(reactAsyncRestOperations.getForEntity(urlTemplate, QNIFlux.class, params).map(HttpEntity::getBody).doOnSuccess(bytes -> LOGGER.info("Piece GED correctement récupéré : %s", idPiece)));

            }
            return Mono.firstWithValue(appelsQNI).block();
        } catch (Exception ex){
            TracesDpiUtils.tracerErreur(3, ex, GedAccesseur.class);
            throw ex;
        }
    }

    private String getUrlTemplate(String serviceUrl) {
        return UriComponentsBuilder.fromHttpUrl(serviceUrl)
                .queryParam(IDLOGIQUE, "{idLogique}")
                .queryParam(CODE_CONTEXTE, "{codeContexte}")
                .queryParam(CODE_ETAB, "{codeEtab}")
                .queryParam(CODE_AUTH, "{codeAuth}")
                .queryParam(CODE_TYPOLOGIE, "{codeTypologie}")
                .encode()
                .toUriString();
    }


}

^^^^^^^^Test
package fr.laposte.disf.canal.h7z.isolation.ged;

import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.QNIFlux;
import fr.laposte.disf.fwmc.arch.rest.http.ReactorAsyncRestOperations;
import fr.laposte.disfe.fwroa.test.bootstrap.DefaultCanalTest;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Map;

import static fr.laposte.disf.canal.h7z.api.piecedemande.ApiMapConstantes.KEY_RECUPERER_DOCUMENT;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyMap;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.BDDMockito.given;
import static org.mockito.Mockito.verify;

@ExtendWith(MockitoExtension.class)
class GedAccesseurTest extends DefaultCanalTest {

    @Mock
    private Map<String, String> api;

    @Mock
    private ReactorAsyncRestOperations reactAsyncRestOperations;

    private GedAccesseur gedAccesseur;

    @BeforeEach
    void init(){
        gedAccesseur = new GedAccesseur(api, reactAsyncRestOperations);
    }

    @Test
    void doitRecupererContenuPdf(){
        given(api.get(KEY_RECUPERER_DOCUMENT)).willReturn("http://localhost:8090/url");
        given(reactAsyncRestOperations.getForEntity(any(), eq(QNIFlux.class), anyMap())).willReturn(Mono.empty());
        var captor = ArgumentCaptor.forClass(Map.class);
        gedAccesseur.recupererDocumentSiPlusieursContextes("123456", "T0021",
            List.of(ContextePiece
                .builder()
                .codeContexte("X00018")
                .codeAuthentification("h1e4")
                .codeEtablissement("00")
                .build())
        );

        verify(reactAsyncRestOperations).getForEntity(anyString(), eq(QNIFlux.class), captor.capture());

        assertThat(captor.getValue()).contains(
            Map.entry("idLogique", "123456"),
            Map.entry("codeContexte", "X00018"),
            Map.entry("codeEtab", "00"),
            Map.entry("codeAuth", "h1e4"),
            Map.entry("codeTypologie", "T0021")
        );
    }

}

^^^^^^Îsoltion
package fr.laposte.disf.canal.h7z.isolation.ged;

import fr.laposte.disf.canal.h7z.domain.Contenu;
import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disf.canal.h7z.domain.PieceDemande;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.InformationsPieceGED;
import fr.laposte.disf.canal.h7z.isolation.mapper.ContenuMapper;
import fr.laposte.disf.canal.h7z.isolation.mapper.PieceDemandeFactory;
import fr.laposte.disf.fwmc.core.ApplicationManager;
import fr.laposte.disf.fwmc.core.log.Logger;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
@RequiredArgsConstructor(onConstructor = @__(@Autowired))
public class GedIsolationManager {

    private static final Logger LOG = ApplicationManager.getLogger(GedIsolationManager.class);

    private final GedAccesseur gedAccesseur;

    private final PieceDemandeFactory pieceDemandeFactory;

    private final ContenuMapper mapper;



    public InformationsPieceGED recupererInformationsPieceGED(String identifiant, ContextePiece contextePiece) {
        return pieceDemandeFactory.apply(gedAccesseur.recupererPiece(identifiant, contextePiece).getObjets());
    }

    public Contenu recupererDocumentSiPlusieursContextes(String idPiece, String codeTypologie, List<ContextePiece> contextes) {
        var qniFLux = gedAccesseur.recupererDocumentSiPlusieursContextes(idPiece, codeTypologie, contextes);
        return mapper.from(qniFLux);

    }

}

^^^^test
package fr.laposte.disf.canal.h7z.isolation.ged;

import fr.laposte.disf.canal.h7z.fixture.ContexteFixture;
import fr.laposte.disf.canal.h7z.fixture.ObjetV3Fixture;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.InformationsPieceGED;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.ListeObjetsV3;
import fr.laposte.disf.canal.h7z.isolation.mapper.ContenuMapper;
import fr.laposte.disf.canal.h7z.isolation.mapper.PieceDemandeFactory;
import fr.laposte.disfe.fwroa.test.bootstrap.DefaultCanalTest;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.time.LocalDate;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyList;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class GedIsolationManagerTest extends DefaultCanalTest {


    @Mock
    private GedAccesseur gedAccesseur;

    @Mock
    private PieceDemandeFactory pieceDemandeFactory;

    @Mock
    private ContenuMapper mapper;

    @InjectMocks
    private GedIsolationManager gedIsolationManager;

    @Test
    void doitRecupererInformationsPieceGED() {
        // GIVEN
        var listeObjet = new ListeObjetsV3();
        listeObjet.setObjets(List.of(ObjetV3Fixture.getDefault()));
        when(gedAccesseur.recupererPiece(anyString(), any())).thenReturn(listeObjet);
        when(pieceDemandeFactory.apply(listeObjet.getObjets()))
                .thenReturn(InformationsPieceGED.builder().format("pdf").taille(2.72f).nomDocument("pièce jointe à la demande").dateProduction(LocalDate.of(2024, 1, 2).toString()).build());
        // WHEN
        var retour = gedIsolationManager.recupererInformationsPieceGED("15a13515-a1eb-4162-a1ba-4c07174f6a16", ContexteFixture.getDefault());
        // THEN
        assertThat(retour).usingRecursiveComparison()
                .isEqualTo(InformationsPieceGED.builder()
                        .format("pdf").taille(2.72f).nomDocument("pièce jointe à la demande").dateProduction(LocalDate.of(2024, 1, 2).toString()).build());
    }

    @Test
    void doitRecupererContenuDocument(){
        gedIsolationManager.recupererDocumentSiPlusieursContextes(any(), any(), anyList());
        verify(gedAccesseur).recupererDocumentSiPlusieursContextes(any(), any(), anyList());
        verify(mapper).from(any());
    }

}


^^^^ dossier service
package fr.laposte.disf.canal.h7z.domain.service;

import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disf.canal.h7z.domain.DossierDetailDemande;
import fr.laposte.disf.canal.h7z.domain.PieceDemande;
import fr.laposte.disf.canal.h7z.domain.Typologie;
import fr.laposte.disf.canal.h7z.isolation.catalogue.CatalogueIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.catalogue.modele.TypologyDHA;
import fr.laposte.disf.canal.h7z.isolation.dossier.DossierCollecteIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.ged.GedIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.InformationsPieceGED;
import fr.laposte.disf.fwmc.core.error.ApplicationException;
import lombok.RequiredArgsConstructor;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor(onConstructor = @__(@Autowired))
public class DossierService {

    private final DossierCollecteIsolationManager dossierAdapter;
    private final CatalogueIsolationManager catalogueAdapter;
    private final GedIsolationManager gedAdapter;

    public DossierDetailDemande recupererDossier(String idDossier) throws ApplicationException {
        return dossierAdapter.recupererDetailDossierDemande(idDossier);
    }

    public List<PieceDemande> recupererPieces(DossierDetailDemande dossier) {
        var contextes = dossier.getContextesPiece();
        var setPieces = dossier.getPiecesDemande();
        return setPieces.stream()
            .map(piece -> ajouterInfosPiece(piece, contextes))
            .collect(Collectors.toList());

    }

    private PieceDemande ajouterInfosPiece(PieceDemande pieceDemande, List<ContextePiece> contextes) {
        String codeTypologie = getCodeTypologie(pieceDemande);

        for (ContextePiece contextePiece : contextes) {

            var typologyDHA = catalogueAdapter.recupererInformationsTypologieCatalogue(contextePiece, codeTypologie);

            var infosGED = gedAdapter.recupererInformationsPieceGED(pieceDemande.getIdentifiant(), contextePiece);

            if (StringUtils.isNotEmpty(typologyDHA.getLibelle())) {
                mettraAJourPieceDemandeAvecInfoGed(pieceDemande, typologyDHA, infosGED);
                pieceDemande.setContexte(contextePiece);
                break;
            }
        }
        return pieceDemande;
    }

    private String getCodeTypologie(PieceDemande pieceDemande) {
        return pieceDemande.getTypologie().getCode();
    }

    private void mettraAJourPieceDemandeAvecInfoGed(PieceDemande pieceDemande, TypologyDHA typologyDHA, InformationsPieceGED infosGED) {
        pieceDemande.setTypologie(Typologie.builder()
            .code(typologyDHA.getCode())
                        .libelle(typologyDHA.getLibelle())
            .build());
        pieceDemande.setFormat(infosGED.getFormat());
        pieceDemande.setTaille(infosGED.getTaille());
        pieceDemande.setLibelle(infosGED.getNomDocument());
        pieceDemande.setDateAcquisition(LocalDate.parse(infosGED.getDateProduction()
            .substring(0, 10), DateTimeFormatter.ofPattern("dd-MM-yyyy")));
    }

}


^^^^test
package fr.laposte.disf.canal.h7z.domain.service;

import fr.laposte.disf.canal.h7z.domain.DossierDetailDemande;
import fr.laposte.disf.canal.h7z.fixture.ContexteFixture;
import fr.laposte.disf.canal.h7z.fixture.PieceDemandeFixture;
import fr.laposte.disf.canal.h7z.isolation.catalogue.CatalogueIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.catalogue.modele.TypologyDHA;
import fr.laposte.disf.canal.h7z.isolation.dossier.DossierCollecteIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.ged.GedIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.InformationsPieceGED;
import fr.laposte.disf.fwmc.core.error.ApplicationException;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.time.LocalDate;
import java.util.Collections;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyList;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class DossierServiceTest {

    @Mock
    private DossierCollecteIsolationManager dossierAdapter;

    @Mock
    private CatalogueIsolationManager catalogueAdapter;

    @Mock
    private GedIsolationManager gedAdapter;

    @InjectMocks
    private DossierService dossierService;

    @Test
    void doitRecupererPieces() {
        // GIVEN
        var pieceDemande = PieceDemandeFixture.getDefault();
        var dossierDetail = new DossierDetailDemande(Collections.singletonList("123456")).addContextesPiece(ContexteFixture.getDefault()).addPiecesDemande(pieceDemande);

        var typologie = TypologyDHA.builder().code("T00846").libelle("Pièce jointe à la demande").build();
        when(catalogueAdapter.recupererInformationsTypologieCatalogue(any(), anyString())).thenReturn(typologie);

        InformationsPieceGED infosGed = InformationsPieceGED.builder().format("pdf").dateProduction("07-03-2024 11:53:40").taille(434.10547f).nomDocument("test nom doc").build();
        when(gedAdapter.recupererInformationsPieceGED(anyString(), any())).thenReturn(infosGed);
        // WHEN
        var listePieces = dossierService.recupererPieces(dossierDetail);
        // THEN
        assertThat(listePieces).hasSize(1);
        var piece = listePieces.get(0);
        assertThat(piece.getIdentifiant()).isEqualTo("15a13515-a1eb-4162-a1ba-4c07174f6a16");
        assertThat(piece.getLibelle()).isEqualTo("test nom doc");
        assertThat(piece.getTypologie().getCode()).isEqualTo("T00846");
        assertThat(piece.getTypologie().getLibelle()).isEqualTo("Pièce jointe à la demande");
        assertThat(piece.getFormat()).isEqualTo("pdf");
        assertThat(piece.getTaille()).isEqualTo(434.10547f);
        assertThat(piece.getDateAcquisition()).isEqualTo(LocalDate.of(2024, 3, 7));
        assertThat(piece.getContexte()).usingRecursiveComparison().isEqualTo(ContexteFixture.getDefault());

    }

    @Test
    void doitRecupererDossier() throws ApplicationException {
        dossierService.recupererDossier("123456");

        verify(dossierAdapter).recupererDetailDossierDemande("123456");

    }

}

^^înfopieceGed
package fr.laposte.disf.canal.h7z.isolation.ged.modele;

import lombok.Builder;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Builder
@EqualsAndHashCode
public class InformationsPieceGED {

    private String format;

    private float taille;

    private String  nomDocument;

    private String dateProduction;

    private String codeTypologie;

    public InformationsPieceGED taille(String taille) {
            this.taille = (float) Integer.parseInt(taille) / 1024;
            return this;
    }
}




---------------------TU
DOSSIER SERVICE
package fr.laposte.disf.canal.h7z.domain.service;

import fr.laposte.disf.canal.h7z.domain.DossierDetailDemande;
import fr.laposte.disf.canal.h7z.domain.PieceDemande;
import fr.laposte.disf.canal.h7z.fixture.ContexteFixture;
import fr.laposte.disf.canal.h7z.fixture.PieceDemandeFixture;
import fr.laposte.disf.canal.h7z.isolation.catalogue.CatalogueIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.catalogue.modele.TypologyDHA;
import fr.laposte.disf.canal.h7z.isolation.ged.GedIsolationManager;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.InformationsPieceGED;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.time.LocalDate;
import java.util.Collections;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class DossierServiceTest {

    @Mock
    private CatalogueIsolationManager catalogueAdapter;

    @Mock
    private GedIsolationManager gedAdapter;

    @InjectMocks
    private DossierService dossierService;

    @Test
    void testAjouterInfosPieceAvecTypologyDHA() {
        // GIVEN
        var pieceDemande = PieceDemandeFixture.getDefault();
        var contextes = List.of(ContexteFixture.getDefault());
        var typologie = TypologyDHA.builder().code("T00846").libelle("Pièce jointe à la demande").build();

        when(catalogueAdapter.recupererInformationsTypologieCatalogue(any(), anyString())).thenReturn(typologie);

        InformationsPieceGED infosGed = InformationsPieceGED.builder().format("pdf").dateProduction("07-03-2024 11:53:40").taille(434.10547f).nomDocument("test nom doc").build();
        when(gedAdapter.recupererInformationsPieceGED(anyString(), any())).thenReturn(infosGed);

        // WHEN
        var piece = dossierService.ajouterInfosPiece(pieceDemande, contextes);

        // THEN
        assertThat(piece.getTypologie().getLibelle()).isEqualTo("Pièce jointe à la demande");
        assertThat(piece.getLibelle()).isEqualTo("test nom doc");
    }

    @Test
    void testAjouterInfosPieceAvecTypologyDHAVide() {
        // GIVEN
        var pieceDemande = PieceDemandeFixture.getDefault();
        var contextes = List.of(ContexteFixture.getDefault());
        var typologieVide = TypologyDHA.builder().code("T00846").libelle("").build();

        when(catalogueAdapter.recupererInformationsTypologieCatalogue(any(), anyString())).thenReturn(typologieVide);

        // WHEN
        var piece = dossierService.ajouterInfosPiece(pieceDemande, contextes);

        // THEN
        assertThat(piece.getTypologie().getLibelle()).isEqualTo(null);
    }
}


////////////////////////
package fr.laposte.disf.canal.h7z.isolation.ged;

import fr.laposte.disf.canal.h7z.domain.ContextePiece;
import fr.laposte.disf.canal.h7z.isolation.ged.modele.ListeObjetsV3;
import fr.laposte.disfe.fwroa.test.bootstrap.DefaultCanalTest;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import reactor.core.publisher.Mono;
import org.springframework.http.ResponseEntity;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.BDDMockito.given;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class GedAccesseurTest extends DefaultCanalTest {

    @Mock
    private ReactorAsyncRestOperations reactAsyncRestOperations;

    private GedAccesseur gedAccesseur;

    @BeforeEach
    void setUp() {
        gedAccesseur = new GedAccesseur(null, reactAsyncRestOperations);
    }

    @Test
    void doitRecupererPiece() {
        var contextePiece = ContextePiece.builder()
                .codeAuthentification("authCode")
                .codeContexte("contexteCode")
                .codeEtablissement("etabCode")
                .build();

        var listeObjets = new ListeObjetsV3();
        
        given(reactAsyncRestOperations.getForEntity(anyString(), eq(ListeObjetsV3.class), any()))
            .willReturn(Mono.just(ResponseEntity.ok(listeObjets)));

        var result = gedAccesseur.recupererPiece("1234", contextePiece);

        assertThat(result).isEqualTo(listeObjets);

        var captor = ArgumentCaptor.forClass(String.class);
        verify(reactAsyncRestOperations).getForEntity(captor.capture(), eq(ListeObjetsV3.class), any());
    }

    @Test
    void doitGererExceptionLorsDeRecuperationDePiece() {
        var contextePiece = ContextePiece.builder()
                .codeAuthentification("authCode")
                .codeContexte("contexteCode")
                .codeEtablissement("etabCode")
                .build();

        given(reactAsyncRestOperations.getForEntity(anyString(), eq(ListeObjetsV3.class), any()))
            .willReturn(Mono.error(new RuntimeException("Erreur de récupération")));

        try {
            gedAccesseur.recupererPiece("1234", contextePiece);
            fail("Expected RuntimeException to be thrown");
        } catch (RuntimeException e) {
            assertThat(e.getMessage()).contains("Erreur de récupération");
        }
    }
}






@Test
void doitRecupererPremierDocumentAvecPlusieursContextes() {
    given(api.get(KEY_RECUPERER_DOCUMENT)).willReturn("http://localhost:8090/url");
    
    var contexte1 = ContextePiece.builder()
            .codeContexte("contexte1")
            .codeAuthentification("auth1")
            .codeEtablissement("etab1")
            .build();
    
    var contexte2 = ContextePiece.builder()
            .codeContexte("contexte2")
            .codeAuthentification("auth2")
            .codeEtablissement("etab2")
            .build();
    
    var flux1 = new QNIFlux();
    var flux2 = new QNIFlux();
    
    given(reactAsyncRestOperations.getForEntity(anyString(), eq(QNIFlux.class), any()))
        .willReturn(Mono.just(flux1), Mono.just(flux2));
    
    var result = gedAccesseur.recupererDocumentSiPlusieursContextes("1234", "T0021", List.of(contexte1, contexte2));
    
    assertThat(result).isEqualTo(flux1);
}

@Test
void doitGererExceptionLorsDeRecuperationSiPlusieursContextes() {
    given(api.get(KEY_RECUPERER_DOCUMENT)).willReturn("http://localhost:8090/url");
    
    var contexte1 = ContextePiece.builder()
            .codeContexte("contexte1")
            .codeAuthentification("auth1")
            .codeEtablissement("etab1")
            .build();
    
    given(reactAsyncRestOperations.getForEntity(anyString(), eq(QNIFlux.class), any()))
        .willReturn(Mono.error(new RuntimeException("Erreur lors de la récupération")));
    
    try {
        gedAccesseur.recupererDocumentSiPlusieursContextes("1234", "T0021", List.of(contexte1));
        fail("Expected RuntimeException to be thrown");
    } catch (RuntimeException e) {
        assertThat(e.getMessage()).contains("Erreur lors de la récupération");
    }
}


